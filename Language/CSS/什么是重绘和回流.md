### 浏览器的渲染过程

![浏览器的渲染过程](images/008.png)

浏览器的渲染过程如下：

1. 解析HTML，生成DOM树，解析css，生成CSSOM树
2. 将DOM树和CSSOM树结合，生成渲染树(Render Tree)
3. reflow(回流)：根据生成的渲染树，进行回流(reflow)，得到节点的几何信息（位置，大小）
4. repaint(重绘)：根据渲染树以及回流得到的几何信息，得到节点的绝对像素
5. Display：将元素发送给GPU，展示在页面上。(有时间会单独写一篇浏览器的渲染过程)

### 重绘

当渲染树中的一些元素需要更新属性，而这些属性只是影响元素的外观、风格，而不会影响布局的操作，比如 background-color，我们将这样的操作称为重绘。

### 回流

当渲染树中的一部分（或全部）因为元素的规模尺寸、布局、隐藏等改变而需要重新构建的操作，会影响到布局的操作，这样的操作我们称为回流。

**回流一定会触发重绘，而重绘不一定会回流**

### 常见引起回流的方法

任何改变元素几何信息（元素的位置和尺寸大小）的操作，都会发生回流。

- 添加或者删除可见的DOM元素
- 元素的位置发生变化
- 元素尺寸改变
- 内容变化，比如input框输入内容，图片被另一个不同尺寸的图片覆盖
- 浏览器窗口尺寸改变resize
- 计算offsetWidth和offsetHeight属性
- 设置style属性的值
- 激活css伪类
- 修改网页默认字体

### 如何减少回流和重绘

#### CSS

- 如果要添加多个子元素，最好使用documentFragment
- 不要使用 table 布局，可能很小的一个小改动会造成整个 table 的重新布局
- 如果你要改变多个属性，最好将这些属性定义在一个class中，直接修改class名，这样只用引起一次回流
- 避免设置多层内联样式
- 将动画效果应用到position属性为absolute或fixed的元素上
- 避免使用CSS表达式（例如：calc()）
- css3硬件加速（GPU加速）：常见的触发硬件加速的css属性，transform，opacity，filters，Will-change

#### JS

- 避免频繁操作样式，最好一次性重写style属性，或者将样式列表定义为class并一次性更改class属性
- 避免频繁操作DOM，创建一个documentFragment，在它上面应用所有DOM操作，最后再把它添加到文档中
- 也可以先为元素设置display: none，操作结束后再把它显示出来。因为在display属性为none的元素上进行的DOM操作不会引发回流和重绘
- 避免触发同步布局事件
- 避免频繁读取会引发回流/重绘的属性，如果确实需要多次使用，就用一个变量缓存起来
- 对具有复杂动画的元素使用绝对定位，使它脱离文档流，否则会引起父元素及后续元素频繁回流
